# spi-backend-plotly API

This backend exposes a small REST API to persist and serve dynamic Plotly figures generated by the LLM.

## Endpoints

- POST `/api/messages`

  - Purpose: Persist a chat message with an associated Plotly visualization code in the `messages` table (column `visualizacion`). Returns the new `msg_id` that also serves as `figure_id`.
  - Request body (any of the following):
    - `{ "visualizacion_code": "<plotly code>", "text": "optional plain text" }`
    - `{ "query": "<instruction>" }` (the code will be generated by the LLM using the in-memory dataframes)
  - Response: `{ "msg_id": <int>, "figure_id": <int>, "text": <string|null> }`

- GET `/api/figures/<figure_id>`

  - Purpose: Return the Plotly JSON for the figure associated to the stored visualization code in `messages.visualizacion`.
  - Response content-type: `application/json`
  - Payload: standard Plotly figure JSON `{ data: [...], layout: { ... } }`.

- POST `/generate-graph`
  - Purpose: Convenience endpoint that generates a figure JSON directly from a `query` (does not persist).
  - Body: `{ "query": "..." }`

## Environment

The database connection is configured via the following env vars (e.g. for Supabase Postgres):

- `DB_NAME`
- `DB_USER`
- `DB_PASSWORD`
- `DB_HOST`
- `DB_PORT`
- `DB_PRODS` (table name for products sample)
- `DB_VARS` (table name for variables sample)
- `DB_MESSAGES` (optional; defaults to `messages`)

## Frontend integration

- The chat service (WebSocket) should send a small JSON to the UI after persisting:

```json
{ "msg_id": 42, "text": "Aquí tienes la evolución de ventas.", "figure_id": 42 }
```

- The UI should render the figure by fetching `/api/figures/42` and passing the JSON to Plotly (e.g., `react-plotly.js`).

## Run locally

The Dash/Flask server runs on port 8007 by default:

```bash
python3 main.py
```

Ensure dependencies from `requirements.txt` are installed in your environment and your `.env` is populated.
